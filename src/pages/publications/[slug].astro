---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getEntry, getCollection } from 'astro:content';
import { toBibTeX, type PublicationRecord } from '../../lib/bibtex';

export async function getStaticPaths() {
  const entries = await getCollection('publications', ({ data }) => !data.draft);
  return entries.map((p) => ({ params: { slug: p.slug } }));
}

const { slug } = Astro.params;
if (!slug) throw new Error('Missing slug');
const entry = await getEntry('publications', slug);
if (!entry) throw new Error(`Publication not found: ${slug}`);

const { title, authors, year, venue, doi, url, tags = [] } = entry.data;
const { Content } = await entry.render();

const record: PublicationRecord = {
  slug,
  title,
  authors,
  year,
  venue,
  doi,
  url,
  tags,
};

const bibtex = toBibTeX(record);

// Schema.org structured data for ScholarlyArticle
const publicationSchema = {
  '@context': 'https://schema.org',
  '@type': 'ScholarlyArticle',
  headline: title,
  author: authors.map((name) => ({
    '@type': 'Person',
    name,
  })),
  datePublished: `${year}-01-01`,
  publisher: {
    '@type': 'Organization',
    name: venue,
  },
  ...(doi && { doi }),
  ...(url && { url }),
  keywords: tags.join(', '),
};
---

<BaseLayout
  title={title}
  description={`Publication: ${title} by ${authors.join(', ')} (${year})`}
  type="article"
  publishedTime={`${year}-01-01`}
  schema={publicationSchema}
>
  <article itemscope itemtype="https://schema.org/ScholarlyArticle">
    <header>
      <h1 itemprop="name">{title}</h1>
      <p class="mt-2 text-gray-700 dark:text-gray-300" itemprop="author">
        {authors.join(', ')}
      </p>
      <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">
        {
          venue && (
            <span itemprop="publisher" itemscope itemtype="https://schema.org/Organization">
              <span itemprop="name">{venue}</span>
              {' Â· '}
            </span>
          )
        }
        <time itemprop="datePublished" datetime={`${year}-01-01`}>{year}</time>
      </p>

      {
        tags.length > 0 && (
          <div class="mt-3 flex gap-2 flex-wrap">
            <span class="sr-only">Tags:</span>
            {tags.map((t) => (
              <span class="inline-flex items-center rounded-full bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 px-2 py-0.5 text-xs">
                {t}
              </span>
            ))}
          </div>
        )
      }
    </header>

    <section class="mt-8" aria-labelledby="links-heading">
      <h2 id="links-heading" class="text-lg font-semibold">Links</h2>
      <ul class="mt-2 space-y-1">
        {
          url && (
            <li>
              <a
                href={url}
                class="text-blue-700 dark:text-blue-400 hover:underline"
                rel="noopener noreferrer"
                target="_blank"
                itemprop="url"
              >
                View on INSPIRE-HEP
              </a>
            </li>
          )
        }
        {
          doi && (
            <li>
              <a
                href={`https://doi.org/${doi}`}
                class="text-blue-700 dark:text-blue-400 hover:underline"
                rel="noopener noreferrer"
                target="_blank"
                itemprop="identifier"
              >
                DOI: {doi}
              </a>
            </li>
          )
        }
        {
          doi && (
            <li>
              <a
                href={`https://arxiv.org/abs/${doi.replace('10.48550/arXiv.', '')}`}
                class="text-blue-700 dark:text-blue-400 hover:underline"
                rel="noopener noreferrer"
                target="_blank"
              >
                arXiv preprint
              </a>
            </li>
          )
        }
      </ul>
    </section>

    <section class="mt-8 prose dark:prose-invert max-w-none" itemprop="description">
      <h2>Abstract</h2>
      <Content />
    </section>

    <section class="mt-8" aria-labelledby="citation-heading">
      <h2 id="citation-heading" class="text-lg font-semibold">Citation</h2>
      <details class="mt-2">
        <summary class="cursor-pointer text-blue-700 dark:text-blue-400 hover:underline">
          Show BibTeX
        </summary>
        <pre
          class="mt-2 p-4 bg-gray-100 dark:bg-gray-900 rounded overflow-x-auto text-sm"><code>{bibtex}</code></pre>
      </details>
    </section>
  </article>
</BaseLayout>
